name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Setting version to $VERSION (build $BUILD_NUMBER)"

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Clean up
          rm $RUNNER_TEMP/certificate.p12

      - name: Build Release
        run: swift build -c release

      - name: Bundle App
        run: |
          chmod +x scripts/bundle-app.sh
          ./scripts/bundle-app.sh "$VERSION" "$BUILD_NUMBER"

      - name: Code Sign App
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          IDENTITY="Developer ID Application: Zhengyi Shen ($APPLE_TEAM_ID)"

          # Sign ONNX Runtime library first
          if [ -f "dist/Voca.app/Contents/Frameworks/libonnxruntime.1.17.0.dylib" ]; then
            codesign --force --options runtime --timestamp \
              --sign "$IDENTITY" \
              "dist/Voca.app/Contents/Frameworks/libonnxruntime.1.17.0.dylib"
            echo "Signed libonnxruntime.1.17.0.dylib"
          fi

          # Sign SPM resource bundle (in Resources)
          if [ -d "dist/Voca.app/Contents/Resources/Voca_Voca.bundle" ]; then
            codesign --force --options runtime --timestamp \
              --sign "$IDENTITY" \
              "dist/Voca.app/Contents/Resources/Voca_Voca.bundle"
            echo "Signed Voca_Voca.bundle"
          fi

          # Sign the framework binary directly (framework has ambiguous structure)
          codesign --force --options runtime --timestamp \
            --sign "$IDENTITY" \
            "dist/Voca.app/Contents/Frameworks/VoicePipeline.framework/Versions/A/VoicePipeline"

          # Sign the framework bundle
          codesign --force --options runtime --timestamp \
            --sign "$IDENTITY" \
            "dist/Voca.app/Contents/Frameworks/VoicePipeline.framework/Versions/A"

          # Sign the main executable
          codesign --force --options runtime --timestamp \
            --sign "$IDENTITY" \
            "dist/Voca.app/Contents/MacOS/Voca"

          # Sign the app bundle
          codesign --force --options runtime --timestamp \
            --sign "$IDENTITY" \
            "dist/Voca.app"

          # Verify signature
          codesign --verify --deep --strict "dist/Voca.app"
          echo "Code signing completed successfully"

      - name: Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create zip for notarization
          ditto -c -k --keepParent "dist/Voca.app" "Voca-notarize.zip"

          # Submit for notarization and wait
          xcrun notarytool submit "Voca-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "dist/Voca.app"

          # Clean up
          rm "Voca-notarize.zip"
          echo "Notarization completed successfully"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Voca" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Voca.app" 150 185 \
            --app-drop-link 450 185 \
            "Voca-${{ env.VERSION }}.dmg" \
            "dist/Voca.app"

      - name: Calculate DMG SHA256
        run: |
          SHA256=$(shasum -a 256 "Voca-${{ env.VERSION }}.dmg" | cut -d ' ' -f 1)
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Voca-${{ env.VERSION }}.dmg
          body: |
            ## Voca ${{ env.VERSION }}

            **Voice-to-text transcription for macOS.**

            ### Installation

            **Download**
            1. Download `Voca-${{ env.VERSION }}.dmg`
            2. Open the DMG and drag Voca to Applications
            3. Grant Accessibility and Microphone permissions when prompted

            **Homebrew**
            ```bash
            brew install --cask zhengyishen0/voca/voca
            ```

            ### Usage

            - Double-tap ⌘ to start recording
            - Release ⌘ to transcribe and auto-paste
            - ⌃⌥V to paste from history
            - ESC to cancel during transcription

            ### Requirements
            - macOS 13.0 (Ventura) or later
            - ~500MB for model downloads (first run)

            ---
            SHA256: `${{ env.SHA256 }}`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/zhengyishen0/homebrew-voca.git
          cd homebrew-voca

          cat > Casks/voca.rb << EOF
          cask "voca" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/zhengyishen0/voca-app/releases/download/v#{version}/Voca-#{version}.dmg"
            name "Voca"
            desc "Voice-to-text transcription for macOS menu bar"
            homepage "https://github.com/zhengyishen0/voca-app"

            depends_on macos: ">= :ventura"

            app "Voca.app"

            zap trash: [
              "~/Library/Preferences/com.zhengyishen.voca.plist",
              "~/Library/Application Support/Voca",
            ]
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/voca.rb
          git commit -m "Update Voca to v${VERSION}"
          git push
